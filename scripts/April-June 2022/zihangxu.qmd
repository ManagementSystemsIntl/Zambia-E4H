---
title: "zihangxu"
format:
  html:
    theme: default
---

```{r}
library(fpp)
library(forecast)
library(backtest)
library(quantmod)
library(tseries)
library(zoo)
library(lubridate)
library(tseries)
library(TSA)
library(scales)
```
#the data we prepare
```{r}
anc1p <- mat %>%
  filter(subpop=="anc1p") %>%
  select(mnthyr, rate, subpop) 

anc1p_pred <- anc1p %>%
  slice(-(52:54))
anc1p_ts <- ts(anc1p_pred$rate)
```
#plot, acf and pacf
```{r}
adf.test(anc1p_ts)
par(mfrow=c(1,3))
plot(anc1p_ts,ylab="rate")
acf(anc1p_ts)
pacf(anc1p_ts)
#seems like the data is non-stationary
#try diff to buil ARIMA, basically we can try log transformation when we have increase trend data
d1=diff(anc1p_ts,differences=1)
par(mfrow=c(1,3))
plot(d1,ylab="rate")
acf(d1)
pacf(d1)
adf.test(d1)
eacf(d1,ma.max = 10)
#much better
# consider ar3,4,15 from pacf
# ma3,4 from acf
```
#try auto first
```{r}

anc1p_arim <- auto.arima(d1)
tsdiag(anc1p_arim)

anc1p_forecast <- data.frame(forecast(anc1p_arim, h=3)) %>%
  mutate(mnthyr=ymd(c("2022-04-01","2022-05-01","2022-06-01")),
         forecast=1) %>%
  select(mnthyr, 
         rate=1,
         lower=4,
         upper=5,
         forecast)
#here the forecast is the diff like Yt-Y(t-1)
anc1p_forecast[1,2:4]=anc1p_forecast[1,2:4]+0.354
anc1p_forecast[2,2:4]=anc1p_forecast[2,2:4]+anc1p_forecast[1,2]
anc1p_forecast[3,2:4]=anc1p_forecast[3,2:4]+anc1p_forecast[2,2]

ggplot(anc1p, aes(mnthyr, rate)) + 
  geom_point(color="dodgerblue") + 
  stat_smooth() + 
  geom_point(data=anc1p_forecast, aes(y=rate), color="darkgoldenrod2") +
  stat_smooth(data=anc1p_forecast, aes(y=rate), color="darkgoldenrod2",fill="darkgoldenrod2") +
  geom_ribbon(data=anc1p_forecast, aes(ymin=lower, ymax=upper),
              fill="darkgoldenrod2",
              alpha=.2) +
  scale_y_continuous(limits=c(0,.5),
                     labels=percent_format(accuracy=1))

```

#try the ar3 model
```{r}
ar3=arima(d1, order=c(3,0,0))
ar3
tsdiag(ar3)#check the diagnostics, seems good

ar3_forecast <- data.frame(predict(ar3,n.ahead=3)$pred) %>%
  mutate(mnthyr=ymd(c("2022-04-01","2022-05-01","2022-06-01")),
         forecast=1) %>%
  select(mnthyr, 
         rate=1,
         lower=4,
         upper=5,
         forecast)

ggplot(anc1p, aes(mnthyr, rate)) + 
  geom_point(color="dodgerblue") + 
  stat_smooth() + 
  geom_point(data=anc1p_forecast, aes(y=rate), color="darkgoldenrod2") +
  stat_smooth(data=anc1p_forecast, aes(y=rate), color="darkgoldenrod2",fill="darkgoldenrod2") +
  geom_ribbon(data=anc1p_forecast, aes(ymin=lower, ymax=upper),
              fill="darkgoldenrod2",
              alpha=.2) +
  scale_y_continuous(limits=c(0,.5),
                     labels=percent_format(accuracy=1))


```